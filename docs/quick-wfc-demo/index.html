<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="John Tringham">







    <meta name="description" content="In the last couple of months I’ve been working on a implementation of the Wave Function Collapse algorithm, which is for creating large patterns out of a selection of smaller tiles that can fit togeth">
<meta property="og:type" content="article">
<meta property="og:title" content="Wave Function Collapse Algorithm for Level Generation">
<meta property="og:url" content="http://blog.seedganggames.com/quick-wfc-demo/index.html">
<meta property="og:site_name" content="Seed Gang Games Blog">
<meta property="og:description" content="In the last couple of months I’ve been working on a implementation of the Wave Function Collapse algorithm, which is for creating large patterns out of a selection of smaller tiles that can fit togeth">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://blog.seedganggames.com/quick-wfc-demo/carcassonne.jpg">
<meta property="og:image" content="http://blog.seedganggames.com/quick-wfc-demo/square-blue-background.PNG">
<meta property="og:image" content="http://blog.seedganggames.com/quick-wfc-demo/cover.png">
<meta property="og:image" content="http://blog.seedganggames.com/quick-wfc-demo/skewing.png">
<meta property="article:published_time" content="2022-07-13T13:04:04.000Z">
<meta property="article:modified_time" content="2023-06-14T07:30:47.253Z">
<meta property="article:author" content="John Tringham">
<meta property="article:tag" content="devlog">
<meta property="article:tag" content="wfc">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.seedganggames.com/quick-wfc-demo/carcassonne.jpg">
<meta name="twitter:creator" content="@zappablamma">

    
<!--  -->

<!--  -->



<title>Wave Function Collapse Algorithm for Level Generation | Seed Gang Games Blog</title>



    <link rel="icon" href="/favicon.ico">



<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&family=Roboto+Mono&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro&family=Fredoka&family=Fredoka+One&family=Source+Code+Pro&family=Staatliches&display=swap');
</style>



    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    




    <!-- scripts list from _config.yml -->
    
    <script src="/js/frame.js"></script>
    










  <meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="Seed Gang Games Blog" type="application/atom+xml">
<link rel="alternate" href="/rss2.xml" title="Seed Gang Games Blog" type="application/rss+xml">
</head>
  <body>
    <div class="mask-border">
    </div>

    <div class="wrapper">

      <div class="header">
  <div class="flex-container">
    <div class="header-inner">
      <div class="site-brand-container">
        <a href="/">
          
            Seed Gang Games Blog.
          
        </a>
      </div>
      <div id="menu-btn" class="menu-btn" onclick="toggleMenu()">
        ☰
      </div>
      <nav class="site-nav">
        <ul class="menu-list">
          
            
              <li class="menu-item">
                <a href="http://seedganggames.com">
                  
                    <a href="http://seedganggames.com">Home</a>
                    
                </a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="/">
                  
                    <a href="/">Blog</a>
                    
                </a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="/archives/">
                  
                    <a href="/archives/">Archive</a>
                    
                </a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="http://john.seedganggames.com/">
                  
                    <a href="http://john.seedganggames.com/">Portfolio</a>
                    
                </a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="https://twitter.com/zappablamma">
                  
                    <img class="menu-img" src=/icon/twitter.png alt=Twitter</img>
                    
                </a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="https://instagram.com/zbsketchbooks">
                  
                    <img class="menu-img" src=/icon/instagram.png alt=Art</img>
                    
                </a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="https://cohost.org/zappablamma">
                  
                    <img class="menu-img" src=/icon/cohostwhite.png alt=Cohost</img>
                    
                </a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="/rss2.xml">
                  
                    <img class="menu-img" src=/icon/rss.png alt=RSS</img>
                    
                </a>
              </li> 
                   
          
        </ul>
      </nav>
    </div>
  </div>
</div>


      
    

      <div class="main">
        <div class="flex-container">
          <article id="post">

  
    <div class="post-head">
    <div class="post-info">
        <div class="post-title">
            
            
                Wave Function Collapse Algorithm for Level Generation
            
            
        </div>
        <div class="post-date">
            Jul 13, 2022
        </div>
    </div>
    <!-- <div class="post-img">
        
            <img src="/quick-wfc-demo/cover.png" alt="featured_image">
              
    </div> -->
</div>
    <div class="post-content">
    <p>In the last couple of months I’ve been working on a implementation of the Wave Function Collapse algorithm, which is for creating large patterns out of a selection of smaller tiles that can fit together. It’s kind of like playing <a href="https://www.google.com/search?q=carcassonne+game&tbm=isch">the board game Carcassone</a>, where there’s a grid of potential places a tile can go, and deciding whether the tile can sit in that position is based on whether the edges of that tile match the neighbouring edges. If you haven’t played it before, it looks like this:</p>
<p><img src="/quick-wfc-demo/carcassonne.jpg"></p>
<p>The WFC algorithm very similar to just playing a round of Carcassone by yourself, but with a bit more forward planning about where you put your next tile. The basic gist is:</p>
<ul>
<li>You put a tile down in a legal spot</li>
<li>For each of the four neighbouring spots, you work out a list of all the possible tiles that could fit there</li>
<li>You then do that again for all the neighbours’ neighbours, calculating which tiles could legally go there</li>
<li>Once you’ve worked out all the potential different tiles for each spot in the grid, you pick the spot with the <em>shortest list of potential tiles</em><ul>
<li>So if there’s a spot that can only accept <em>one specific type of tile</em>, you’ll end up picking that one</li>
</ul>
</li>
<li>You then place a legal tile in that spot, and repeat the whole process over again with the remaining empty spots</li>
</ul>
<p>You keep doing this until the entire area is filled up (or you get a spot that can’t be filled because it requires a type of tile that doesn’t exist - but if you have a decent variety of tiles then this shouldn’t happen often).</p>
<p>This algorithm isn’t simple, but it isn’t too difficult either - you just need to maintain lot of lists that specify what tiles are legally allowed in each position.</p>
<p>Here’s my version running on a regular square grid, using a basic set of “desert rock” tiles:</p>
<video width="100%" autoplay muted controls loop> <source src="/quick-wfc-demo/squarevideo.mp4" type="video/mp4"> </video>

<p>End result (with the background removed so it’s easier to see):</p>
<span id="more"></span>

<p><img src="/quick-wfc-demo/square-blue-background.PNG"></p>
<p>It works well, but it’s a bit boring. From looking at the end result, it’s pretty obvious it was made using a grid based method, as there’s a lot of straight lines and right angles. Rocks that are very far apart run parallel to one another, which isn’t something that would happen in nature. Reuse of tiles is quite obvious when you look a bit closer. Everything is the exact same size. It’s a fine system if you want to block out an office layout, but it doesn’t really look that natural.</p>
<h2 id="Non-Square-Grids"><a href="#Non-Square-Grids" class="headerlink" title="Non Square Grids"></a>Non Square Grids</h2><p>The cool thing about the WFC algorithm is that it doesn’t actually require a regular square grid to run. All the “grid” needs to do is list a bunch of cells, and to dictate what cells neighbour each other. So instead of doing using a boring regular square grid, we can use something like this:</p>
<p><img src="/quick-wfc-demo/cover.png"></p>
<p>Here, every cell still has 4 edges, each of which can be shared by exactly one other cell - these are the only requirements for a grid for our version of WFC. It might look a bit weird, but (in theory) it works just as well as a regular grid.</p>
<p>With this grid we see some cooler patterns, like:</p>
<ul>
<li>Rows of cells that gently curve</li>
<li>Points where 3 or 5 cells meet at a corner (rather than only ever 4 meeting in the regular grid)</li>
<li>Variation in size and shape of the cells</li>
</ul>
<p>But it also raises some questions:</p>
<ul>
<li>How do you even generate a grid like this in the first place?</li>
<li>How do you get around the fact cells can’t have an (x,y) coordinate any more? And neighbours aren’t axis-aligned?</li>
<li>How do you squash a square tile into a non-square cell?</li>
<li>Why are you doing this, you utter mad man?</li>
</ul>
<p>Each of these questions caused me a lot of pain.</p>
<p>I’ll keep the answers brief to not bring up too much suffering:</p>
<h2 id="How-do-you-even-generate-a-grid-like-this-in-the-first-place"><a href="#How-do-you-even-generate-a-grid-like-this-in-the-first-place" class="headerlink" title="How do you even generate a grid like this in the first place?"></a>How do you even generate a grid like this in the first place?</h2><p>The algorithm for making a grid like this was originally thought up by <a href="https://twitter.com/OskSta/status/1147778221058023424">Oskar Stalberg</a> (who, by the way, is an absolute genius and I wouldn’t have gotten half of this done without his extensive posting on the topic). You basically create a bunch of triangles, and merge some of them together - this creates a mixture of triangles and quads. If you then subdivide everything, you get a bunch of quads that fit our requirements. You can then run a relaxation algorithm on all these points to smooth it out a bit. </p>
<p><a href="https://twitter.com/OskSta/status/1147881669350891521">This gif by Oskar</a> demos the process very well.</p>
<h2 id="How-do-you-get-around-the-fact-cells-can’t-have-an-x-y-coordinate-any-more-And-neighbours-aren’t-axis-aligned"><a href="#How-do-you-get-around-the-fact-cells-can’t-have-an-x-y-coordinate-any-more-And-neighbours-aren’t-axis-aligned" class="headerlink" title="How do you get around the fact cells can’t have an (x,y) coordinate any more? And neighbours aren’t axis-aligned?"></a>How do you get around the fact cells can’t have an (x,y) coordinate any more? And neighbours aren’t axis-aligned?</h2><p>Yeah that was a pain. </p>
<p>With a square grid, you can label each cell with an <code>x</code> and <code>y</code> position, which is handy. You can also work out neighbouring cells really easily, because to get the cell to the north, you just add 1 to the <code>y</code> position, or for the west you just subtract one from the <code>x</code>.</p>
<p>But with an irregular grid you can’t, because concepts like “north neighbour” and “cell position” don’t mean anything any more. You can’t give any cells a meaningful <code>x</code> and <code>y</code> coordinate.</p>
<p>There’s not a good mathematical shortcut here for getting around this stuff, because this grid is disorganised <em>by design</em>. The only way is to just have a good object model and manually keep track of what vertices and edges are shared between cells.</p>
<h2 id="How-do-you-squash-a-tile-into-a-non-square-cell"><a href="#How-do-you-squash-a-tile-into-a-non-square-cell" class="headerlink" title="How do you squash a tile into a non-square cell?"></a>How do you squash a tile into a non-square cell?</h2><p>The problem is that we now have square tiles, but we want to fit them into non-square cells, and we still want to line everything up so all the edges fit nicely together.</p>
<p>This is basically like skewing an image.<br>We’ve got some stuff in a square here, and we want to put it in some arbitrary quad over there, but we want the contents to translate in a way that makes visual sense. All we need is a way of translating individual points from one to the other.</p>
<p>The method I ended up with was using lerps and inverse lerps. Assuming a normalised <code>(0,0)</code> to <code>(1,1)</code> set of coordinates in the base module, we can do something like this, where we want to translate point <code>P=(X,Y)</code> to the point <code>P&#39;</code> inside the quad <code>ABCD</code>:</p>
<p><img src="/quick-wfc-demo/skewing.png"></p>
<p>where:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Q = Vector3.Lerp(A, B, X);</span><br><span class="line">R = Vector3.Lerp(D, C, X);</span><br><span class="line">P` = Vector3.Lerp(R, Q, Y);</span><br></pre></td></tr></table></figure>

<p>Here, we’re using lerps to figure out where in this new quad the point should sit. This works for pixels on bitmaps, or vertices on meshes, and it’s the basic idea behind how it squashes the mesh into the irregular cell. </p>
<p>This method doesn’t work if the quad is concave, but if that’s happened you’re screwed already.</p>
<p>There’s a lot more I could talk about but this post is already far too long! Hopefully it was interesting! If you want to ask any questions about it I’ve got a <a href="https://twitter.com/zappablamma/status/1546919431107911680">twitter thread</a> going - feel free to reply there :)</p>
<p>Finally, here’s a quick clip of the algorithm running on an irregular grid (also shows the grid generation and some very early gameplay footage).</p>
<video width="100%" autoplay muted controls loop> <source src="/quick-wfc-demo/levelgenvid.mp4" type="video/mp4"> </video>
</div> 

<script>
    window.onload = detectors();
</script>
    <div class="post-footer">
    <div class="tag-list">
        
            
                <span class="post-tag">
                    <a href="/tags/devlog/">
                        devlog
                    </a>
                </span>    
            
                <span class="post-tag">
                    <a href="/tags/wfc/">
                        wfc
                    </a>
                </span>    
                       
        
    </div>
    <div class="h-line-primary"></div>
    
    <nav class="post-nav">
        <div class="prev-item">
           
                <div class="fake-icon"><a href="/vectorpark-egg/">←</a></div>
                <div class="post-link">
                    <a href="/vectorpark-egg/">Flash, flipbooks, Vectorpark and me</a>
                </div>
            
        </div>
        <div style="width:10%"></div>
        <div class="next-item">
            
                <div class="fake-icon"><a href="/evaze-released/">→</a></div>
                <div class="post-link">
                  <a href="/evaze-released/">Evaze Released!</a>  
                </div>  
            
        </div>
    </nav>
</div>

    
      <div class="post-comment">

     

     
    
    

</div>
     
  
</article>
        </div>
      </div>
      
      <div class="footer">
    <div class="flex-container">
        <div class="footer-text">
            
                
                <br>
            
            
                Seed Gang Games / John Tringham |
            
            
                Website powered by <a href="https://hexo.io/">Hexo</a>, <a href="https://github.com/zoeingwingkei/frame/">Frame</a>, and <a href="https://surge.sh">Surge</a>
                
        </div>
    </div>
</div>

    </div>

  </body>
</html>
